<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON Formatter - Playlab42</title>
  <link rel="stylesheet" href="/lib/theme.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      background: var(--color-bg);
      color: var(--color-text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background-color var(--transition-normal), color var(--transition-normal);
    }

    header {
      padding: var(--space-md);
      background: var(--color-bg-secondary);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color var(--transition-normal), border-color var(--transition-normal);
    }

    header h1 {
      font-size: var(--font-size-lg);
      font-weight: 600;
    }

    header h1 span {
      color: var(--color-accent);
    }

    .actions {
      display: flex;
      gap: var(--space-sm);
    }

    button {
      padding: var(--space-sm) var(--space-md);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: var(--font-size-sm);
      font-weight: 500;
      transition: all var(--transition-normal);
    }

    button.primary {
      background: var(--color-accent);
      color: white;
    }

    button.primary:hover {
      background: var(--color-accent-hover);
    }

    button.secondary {
      background: var(--color-bg);
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }

    button.secondary:hover {
      background: var(--color-border);
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: var(--color-border);
    }

    @media (max-width: 768px) {
      main {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr;
      }
    }

    .panel {
      background: var(--color-bg);
      display: flex;
      flex-direction: column;
      transition: background-color var(--transition-normal);
    }

    .panel-header {
      padding: 0.75rem var(--space-md);
      background: var(--color-bg-secondary);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color var(--transition-normal), border-color var(--transition-normal);
    }

    .panel-header h2 {
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--color-text-muted);
    }

    .status {
      font-size: var(--font-size-xs);
      padding: var(--space-xs) var(--space-sm);
      border-radius: 3px;
    }

    .status.valid {
      background: var(--color-success-light);
      color: var(--color-success);
    }

    .status.invalid {
      background: var(--color-error-light);
      color: var(--color-error);
    }

    textarea {
      flex: 1;
      padding: var(--space-md);
      background: var(--color-bg);
      border: none;
      color: var(--color-text);
      font-family: var(--font-mono);
      font-size: var(--font-size-sm);
      line-height: 1.5;
      resize: none;
      outline: none;
      transition: background-color var(--transition-normal), color var(--transition-normal);
    }

    textarea::placeholder {
      color: var(--color-text-muted);
    }

    .output {
      flex: 1;
      padding: var(--space-md);
      overflow: auto;
      font-family: var(--font-mono);
      font-size: var(--font-size-sm);
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .output.error {
      color: var(--color-error);
    }

    /* Coloration syntaxique */
    .string { color: var(--color-syntax-string); }
    .number { color: var(--color-syntax-number); }
    .boolean { color: var(--color-syntax-boolean); }
    .null { color: var(--color-syntax-null); }
    .key { color: var(--color-syntax-key); }

    footer {
      padding: var(--space-sm) var(--space-md);
      background: var(--color-bg-secondary);
      border-top: 1px solid var(--color-border);
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      display: flex;
      justify-content: space-between;
      transition: background-color var(--transition-normal), border-color var(--transition-normal);
    }

    .kbd {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: 3px;
      font-family: var(--font-mono);
      font-size: var(--font-size-xs);
      transition: background-color var(--transition-normal), border-color var(--transition-normal);
    }
  </style>
  <script type="module">
    import { initTheme } from '/lib/theme.js';
    initTheme();
  </script>
</head>
<body>
  <header>
    <h1><span>ðŸ“‹</span> JSON Formatter</h1>
    <div class="actions">
      <button class="secondary" id="btn-minify">Minifier</button>
      <button class="secondary" id="btn-copy">Copier</button>
      <button class="primary" id="btn-format">Formater</button>
    </div>
  </header>

  <main>
    <div class="panel">
      <div class="panel-header">
        <h2>EntrÃ©e</h2>
        <span class="status" id="status"></span>
      </div>
      <textarea
        id="input"
        placeholder="Collez votre JSON ici..."
        spellcheck="false"
      ></textarea>
    </div>

    <div class="panel">
      <div class="panel-header">
        <h2>Sortie</h2>
        <span id="size"></span>
      </div>
      <div class="output" id="output"></div>
    </div>
  </main>

  <footer>
    <span>Playlab42 - JSON Formatter</span>
    <span><span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> pour formater</span>
  </footer>

  <script type="module">
    import { $, on, debounce, escapeHtml } from '/lib/dom.js';

    // Ã‰lÃ©ments DOM
    const inputEl = $('#input');
    const outputEl = $('#output');
    const statusEl = $('#status');
    const sizeEl = $('#size');
    const btnFormat = $('#btn-format');
    const btnMinify = $('#btn-minify');
    const btnCopy = $('#btn-copy');

    // Ã‰tat
    let lastValidJSON = null;
    const indentSize = 2;

    /**
     * Applique la coloration syntaxique au JSON (sans innerHTML dangereux)
     */
    function highlightJSON(json) {
      // Ã‰chapper le HTML d'abord
      const escaped = escapeHtml(json);
      // Puis appliquer les classes de coloration
      return escaped
        .replace(/"([^"\\]*(\\.[^"\\]*)*)"\s*:/g, '<span class="key">"$1"</span>:')
        .replace(/"([^"\\]*(\\.[^"\\]*)*)"/g, '<span class="string">"$1"</span>')
        .replace(/\b(-?\d+\.?\d*)\b/g, '<span class="number">$1</span>')
        .replace(/\b(true|false)\b/g, '<span class="boolean">$1</span>')
        .replace(/\bnull\b/g, '<span class="null">null</span>');
    }

    /**
     * Formate le JSON avec indentation
     */
    function formatJSON() {
      const input = inputEl.value.trim();

      if (!input) {
        outputEl.innerHTML = '';
        statusEl.textContent = '';
        statusEl.className = 'status';
        sizeEl.textContent = '';
        return;
      }

      try {
        const parsed = JSON.parse(input);
        lastValidJSON = parsed;
        const formatted = JSON.stringify(parsed, null, indentSize);

        outputEl.innerHTML = highlightJSON(formatted);
        outputEl.classList.remove('error');

        statusEl.textContent = 'Valide âœ“';
        statusEl.className = 'status valid';

        const bytes = new Blob([formatted]).size;
        sizeEl.textContent = formatBytes(bytes);
      } catch (e) {
        outputEl.textContent = `Erreur de syntaxe:\n${e.message}`;
        outputEl.classList.add('error');

        statusEl.textContent = 'Invalide âœ—';
        statusEl.className = 'status invalid';
        sizeEl.textContent = '';
      }
    }

    /**
     * Minifie le JSON
     */
    function minifyJSON() {
      if (!lastValidJSON) {
        formatJSON();
        if (!lastValidJSON) return;
      }

      const minified = JSON.stringify(lastValidJSON);
      outputEl.innerHTML = highlightJSON(minified);
      outputEl.classList.remove('error');

      const bytes = new Blob([minified]).size;
      sizeEl.textContent = formatBytes(bytes);
    }

    /**
     * Copie le rÃ©sultat dans le presse-papiers
     */
    async function copyOutput() {
      const text = outputEl.textContent;
      if (!text) return;

      try {
        await navigator.clipboard.writeText(text);
        const originalText = btnCopy.textContent;
        btnCopy.textContent = 'CopiÃ© !';
        setTimeout(() => {
          btnCopy.textContent = originalText;
        }, 1500);
      } catch (e) {
        console.error('Erreur copie:', e);
      }
    }

    /**
     * Formate une taille en bytes
     */
    function formatBytes(bytes) {
      if (bytes < 1024) return `${bytes} B`;
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
      return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    }

    // Event listeners
    on(btnFormat, 'click', formatJSON);
    on(btnMinify, 'click', minifyJSON);
    on(btnCopy, 'click', copyOutput);

    // Auto-format au fur et Ã  mesure (dÃ©bounce)
    on(inputEl, 'input', debounce(formatJSON, 300));

    // Raccourci clavier Ctrl+Enter
    on(inputEl, 'keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        formatJSON();
      }
    });

    // Charger depuis l'URL si prÃ©sent
    const urlParams = new URLSearchParams(window.location.search);
    const jsonParam = urlParams.get('json');
    if (jsonParam) {
      try {
        inputEl.value = decodeURIComponent(jsonParam);
        formatJSON();
      } catch (e) {
        console.error('Erreur chargement JSON depuis URL:', e);
      }
    }

    // Focus initial
    inputEl.focus();
  </script>
</body>
</html>
